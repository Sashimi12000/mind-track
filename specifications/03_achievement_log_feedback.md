# **AF-1. 達成ログ＆承認フィードバック機能 仕様詳細** {#AF-1}

## **AF-1.1. 目的** {#AF-1.1}

マイクロタスクの完了という「小さな成功体験」を即座にユーザーにフィードバックし、自己肯定感を高める。

## **AF-1.2. UI/UX** {#AF-1.2}

### **AF-1.2.1. フィードバック表示方式** {#AF-1.2.1}

*   **表示タイミング**: マイクロタスクの完了チェック直後（0.2〜0.5秒の遅延）
*   **表示場所**: 画面中央部（モーダルオーバーレイ）
*   **表示時間**: 2〜3秒間の自動表示、クリック/タップで即座に閉じる

### **AF-1.2.2. 視覚的フィードバック** {#AF-1.2.2}

1.  **メッセージ表示**:
    *   **UI**: daisyUIの `alert` または `toast` コンポーネントベース
    *   **デザイン**: 明るく温かみのあるカラーパレット（グリーン、イエロー等）
    *   **サイズ**: モバイル対応可能な適切なサイズ（最大幅: 90vw）

2.  **アニメーション効果**:
    *   **登場**: フェードイン + スケールアップ（0.8→1.0）
    *   **滞在**: 軽微なパルス効果または静止
    *   **退場**: フェードアウト + スケールダウン（1.0→0.9）
    *   **継続時間**: 各アニメーション 0.3〜0.5秒

3.  **オプション演出**:
    *   **紙吹雪エフェクト**: CSS Particlesまたは軽量なJavaScriptライブラリ
    *   **アイコン表示**: ✨、🎉、👏等の絵文字やSVGアイコン
    *   **背景グラデーション**: 成功感を演出する色彩効果

### **AF-1.0.1. 音響フィードバック** {#AF-1.0.1}

1.  **効果音**:
    *   **音源**: 短い成功音（0.5〜1.0秒）
    *   **候補音**: キラキラ、ポロン、チャイム、ベル音
    *   **ファイル形式**: MP3/OGGの軽量ファイル（10KB以下）
    *   **音量**: システム音量の50%程度

2.  **音響制御**:
    *   **設定**: ユーザーによるON/OFF切り替え可能
    *   **フォールバック**: 音響再生失敗時のサイレント処理

### **AF-1.2.3. 音響フィードバック** {#AF-1.2.3}

1.  **効果音**:
    *   **音源**: 短い成功音（0.5〜1.0秒）
    *   **候補音**: キラキラ、ポロン、チャイム、ベル音
    *   **ファイル形式**: MP3/OGGの軽量ファイル（10KB以下）
    *   **音量**: システム音量の50%程度

2.  **音響制御**:
    *   **設定**: ユーザーによるON/OFF切り替え可能
    *   **フォールバック**: 音響再生失敗時のサイレント処理

## **AF-1.3. メッセージ生成ロジック** {#AF-1.3}

### **AF-1.3.1. メッセージテンプレート** {#AF-1.3.1}

1.  **通常メッセージ** (タスク名30文字以下):
    *   「『{task_description}』を達成！素晴らしい一歩です！」
    *   「ナイス！『{task_description}』を完了しましたね！」
    *   「よくできました！『{task_description}』をクリア！」
    *   「お疲れさまでした！『{task_description}』達成です！」
    *   「すごい！『{task_description}』をやり遂げましたね！」

2.  **汎用メッセージ** (タスク名30文字超過時):
    *   「タスクを一つ達成！その調子です！」
    *   「マイクロタスク完了！よくがんばりました！」
    *   「一歩前進！素晴らしい成果です！」
    *   「達成おめでとうございます！」
    *   「小さな成功の積み重ね！順調です！」

### **AF-1.3.2. メッセージ選択ロジック** {#AF-1.3.2}

*   **ランダム選択**: テンプレートからランダムに選択
*   **重複回避**: 直近3回と同じメッセージを避ける
*   **文字数判定**: タスク名の文字数で通常/汎用を切り分け
*   **特別条件**: 連続達成、初回達成等での特別メッセージ

### **AF-1.3.3. パーソナライゼーション** {#AF-1.3.3}

*   **達成回数反映**: 「今日◯個目の達成！」等の追加情報
*   **時間帯考慮**: 朝・昼・夜での挨拶パターン変更
*   **連続記録**: 連続達成日数の表示

## **AF-1.4. データ構造 (SQLite: achievement_logs テーブル)** {#AF-1.4}

| カラム名              | 型      | 制約                               | 説明                                     |
| --------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `local_id`            | INTEGER | PRIMARY KEY AUTOINCREMENT          | ローカルID                               |
| `uuid`                | TEXT    | NOT NULL, UNIQUE                   | グローバル一意ID (UUID v4)               |
| `micro_task_uuid`     | TEXT    | NOT NULL                           | 関連マイクロタスクのUUID                 |
| `achievement_message` | TEXT    | NOT NULL, max 200 chars           | 表示されたメッセージ                     |
| `message_template_id` | TEXT    | NULL許容                           | 使用されたテンプレートID                 |
| `feedback_type`       | TEXT    | NOT NULL                           | フィードバック種別 (success/milestone)   |
| `animation_enabled`   | INTEGER | NOT NULL DEFAULT 1                 | アニメーション表示フラグ                 |
| `sound_enabled`       | INTEGER | NOT NULL DEFAULT 1                 | 効果音再生フラグ                         |
| `created_at`          | TEXT    | NOT NULL                           | 達成記録日時 (ISO 8601 UTC)              |

**検討事項:**
*   `message_template_id`: メッセージの効果測定やA/Bテストに活用
*   `feedback_type`: 通常達成以外の特別な達成（連続記録等）の分類
*   設定フラグ: 表示時の設定を記録し、統計分析に活用

## **AF-1.5. 設定管理 (SQLite: user_preferences テーブル)** {#AF-1.5}

| カラム名              | 型      | 制約                               | 説明                                     |
| --------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `preference_key`      | TEXT    | PRIMARY KEY                        | 設定項目名                               |
| `preference_value`    | TEXT    | NOT NULL                           | 設定値 (JSON文字列)                      |
| `updated_at`          | TEXT    | NOT NULL                           | 更新日時 (ISO 8601 UTC)                  |

**設定項目:**
*   `achievement_animation_enabled`: アニメーション有効/無効
*   `achievement_sound_enabled`: 効果音有効/無効
*   `achievement_feedback_style`: フィードバックスタイル設定

## **AF-1.6. バックエンド処理 (Rust - Tauri Commands)** {#AF-1.6}

### **AF-1.0.2. `record_achievement` コマンド** {#AF-1.0.2}

*   **入力ペイロード**:
    ```typescript
    interface RecordAchievementPayload {
      microTaskUuid: string;
      achievementMessage: string;
      messageTemplateId?: string;
      feedbackType: 'success' | 'milestone';
    }
    ```

*   **処理フロー**:
    1. マイクロタスクの完了状態確認
    2. 達成ログレコード作成
    3. 統計データ更新（連続達成記録等）
    4. 成功時: 達成ログUUID返却

### **AF-1.0.3. `get_user_preferences` コマンド** {#AF-1.0.3}

*   **入力**: なし
*   **出力**: ユーザー設定オブジェクト
*   **用途**: フィードバック表示前の設定確認

### **AF-1.0.4. `update_user_preferences` コマンド** {#AF-1.0.4}

*   **入力**: 設定キーと値のペア
*   **処理**: user_preferencesテーブルの更新

### **AF-1.0.5. `get_achievement_stats` コマンド** {#AF-1.0.5}

*   **入力**: 期間指定（オプション）
*   **出力**: 達成統計データ（総数、連続記録、日別データ等）

## **AF-1.1. フロントエンド処理 (SvelteKit)** {#AF-1.1}

### **AF-1.1.1. フィードバック表示制御** {#AF-1.1.1}

*   **トリガー**: マイクロタスク完了イベント
*   **前処理**: ユーザー設定の確認
*   **表示**: 条件に応じたアニメーション・音響の実行
*   **後処理**: 達成ログの記録

### **AF-1.1.2. 設定画面** {#AF-1.1.2}

*   **場所**: アプリ設定画面内の専用セクション
*   **項目**: アニメーション/効果音のON/OFF切り替え
*   **プレビュー**: 設定変更時のリアルタイムプレビュー機能

### **AF-1.1.3. 統計表示** {#AF-1.1.3}

*   **場所**: ふりかえり機能との連携
*   **内容**: 達成回数、連続記録、時間別達成パターン等
*   **更新**: リアルタイム反映

## **AF-1.8. 不明点・検討事項リスト** {#AF-1.8}

### **AF-1.8.1. UI/UX 関連** {#AF-1.8.1}
*   **表示位置詳細**: 画面中央の具体的な位置（上下の余白、他要素との重なり）
*   **モバイル対応**: 小画面での表示最適化、横向き画面での対応
*   **アニメーションパフォーマンス**: 低スペック端末での動作確認
*   **紙吹雪エフェクト**: 実装ライブラリの選定、パフォーマンス影響
*   **色覚対応**: カラーアクセシビリティの確保
*   **ダークモード**: テーマ切り替えでのデザイン調整
*   **マルチタスク完了**: 複数タスク同時完了時のフィードバック制御
*   **中断操作**: フィードバック表示中のユーザー操作への対応

### **AF-1.8.2. メッセージ・コンテンツ関連** {#AF-1.8.2}
*   **国際化**: 多言語対応時のメッセージテンプレート管理
*   **カスタマイズ**: ユーザーによるメッセージの追加・編集機能
*   **感情分析**: タスク内容に応じたメッセージ調整
*   **特別メッセージ**: 記念日、マイルストーン達成時の特別演出
*   **ネガティブフィードバック**: 失敗時のサポートメッセージ
*   **文字数制限**: 長いタスク名の省略表示ルール

### **AF-1.8.3. 音響・アクセシビリティ関連** {#AF-1.8.3}
*   **音響ファイル**: ライセンス、品質、ファイルサイズの最適化
*   **音量調整**: ユーザーによる音量レベル設定
*   **アクセシビリティ**: スクリーンリーダー対応、音響フィードバック
*   **システム連携**: OS通知センターとの連携
*   **振動フィードバック**: モバイル端末でのハプティックフィードバック

### **AF-1.8.4. データ・パフォーマンス関連** {#AF-1.8.4}
*   **ログデータ量**: 長期利用時のデータ蓄積と管理
*   **リアルタイム性**: フィードバック表示の応答速度要件
*   **同期処理**: 複数デバイス間での達成状況同期
*   **オフライン対応**: ネットワーク切断時のフィードバック処理
*   **データプライバシー**: 達成ログの保存期間と削除ポリシー

### **AF-1.8.5. 設定・カスタマイズ関連** {#AF-1.8.5}
*   **詳細設定**: アニメーション速度、効果音音量の細かい調整
*   **プロファイル**: ユーザー属性に応じたデフォルト設定
*   **A/Bテスト**: メッセージ効果の測定と最適化
*   **学習機能**: ユーザーの反応に基づくメッセージ調整

### **AF-1.8.6. 運用・保守関連** {#AF-1.8.6}
*   **効果測定**: フィードバック機能の利用状況とモチベーション効果
*   **メッセージ管理**: テンプレートの追加・更新・削除プロセス
*   **バグ対応**: アニメーション/音響再生エラーの処理
*   **パフォーマンス監視**: 表示遅延、メモリ使用量の測定

---
