# **RM-1. リマインダー機能 仕様詳細** {#RM-1}

## **RM-1.1. 目的** {#RM-1.1}

行動の習慣化をサポートし、「やらなきゃ」と意識し続けることによるワーキングメモリの負荷を軽減する。

## **RM-1.2. UI/UX** {#RM-1.2}

### **RM-1.2.1. 設定画面** {#RM-1.2.1}

1.  **設定項目レイアウト**:
    *   **場所**: アプリ設定画面内の「通知・リマインダー」セクション
    *   **構成**: カード形式で機能別に分割表示
    *   **UI**: daisyUIのcard、toggle、time-inputコンポーネント

2.  **デイリーチェックイン設定**:
    *   **有効/無効**: トグルスイッチ
    *   **時刻設定**: 時間選択UI（時:分）
    *   **曜日選択**: 毎日 or 特定曜日選択（チェックボックス）
    *   **プレビュー**: 「次回通知: ◯月◯日 ◯時◯分」表示

3.  **未完了タスク設定**:
    *   **有効/無効**: トグルスイッチ
    *   **時刻設定**: 時間選択UI
    *   **条件設定**: 通知する最小未完了タスク数
    *   **頻度制限**: 1日1回 or 複数回

4.  **通知許可設定**:
    *   **権限確認**: OS通知権限の確認・要求ボタン
    *   **権限状態**: 現在の許可状況表示
    *   **設定ガイド**: OS設定画面への誘導リンク

### **RM-1.2.2. 通知表示** {#RM-1.2.2}

1.  **通知内容**:
    *   **タイトル**: 「Mindtrack」
    *   **メッセージ**: 目的に応じたメッセージ
    *   **アイコン**: アプリアイコン
    *   **アクション**: タップでアプリ起動・画面遷移

2.  **メッセージパターン**:
    *   **デイリーチェックイン**: 
        * 「今日のチェックインしませんか？」
        * 「今日の調子はいかがですか？」
        * 「一日の振り返りタイムです」
    *   **未完了タスク**:
        * 「まだタスクが残っていますよ」
        * 「今日のタスク、一つずつでも大丈夫です」
        * 「小さな一歩を踏み出しませんか？」

## **RM-1.3. OS別実装** {#RM-1.3}

### **RM-1.3.1. 共通仕様** {#RM-1.3.1}

*   **通知ライブラリ**: Tauri公式プラグイン `@tauri-apps/plugin-notification`
*   **権限管理**: 初回設定時の権限要求、権限状態の監視
*   **ディープリンク**: URLスキーム `mindtrack://` による画面遷移

### **RM-1.3.2. プラットフォーム別対応** {#RM-1.3.2}

1.  **Windows**:
    *   **表示形式**: Windows 10/11 通知センター
    *   **音声**: システム通知音
    *   **持続性**: 一定時間で自動消去

2.  **macOS**:
    *   **表示形式**: macOS Notification Center
    *   **音声**: システム通知音
    *   **バナー/アラート**: macOSシステム設定に従う

3.  **iOS**:
    *   **表示形式**: iOS通知センター
    *   **音声**: システム設定に従う
    *   **バッジ**: アプリアイコンバッジ数の更新

### **RM-1.3.3. ディープリンク定義** {#RM-1.3.3}

*   **チェックイン**: `mindtrack://checkin`
*   **タスク**: `mindtrack://tasks`
*   **設定**: `mindtrack://settings`
*   **ホーム**: `mindtrack://` (デフォルト)

## **RM-1.4. データ構造** {#RM-1.4}

### **RM-1.4.1. reminder_settings テーブル** {#RM-1.4.1}

| カラム名                    | 型      | 制約                               | 説明                                     |
| --------------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `setting_key`               | TEXT    | PRIMARY KEY                        | 設定項目識別子                           |
| `is_enabled`                | INTEGER | NOT NULL DEFAULT 0                 | 有効/無効フラグ                          |
| `schedule_time`             | TEXT    | NULL許容, HH:MM形式                | 通知時刻                                 |
| `schedule_days`             | TEXT    | NULL許容                           | 通知曜日 (JSON配列: [0-6])               |
| `message_template`          | TEXT    | NULL許容                           | メッセージテンプレート                   |
| `last_triggered_at`         | TEXT    | NULL許容                           | 最後の通知実行日時 (ISO 8601 UTC)        |
| `updated_at`                | TEXT    | NOT NULL                           | 設定更新日時 (ISO 8601 UTC)              |

**設定項目例:**
*   `daily_checkin_reminder`: デイリーチェックイン通知
*   `pending_tasks_reminder`: 未完了タスク通知

### **RM-1.4.2. notification_logs テーブル** {#RM-1.4.2}

| カラム名              | 型      | 制約                               | 説明                                     |
| --------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `local_id`            | INTEGER | PRIMARY KEY AUTOINCREMENT          | ローカルID                               |
| `uuid`                | TEXT    | NOT NULL, UNIQUE                   | グローバル一意ID (UUID v4)               |
| `reminder_type`       | TEXT    | NOT NULL                           | リマインダー種別                         |
| `message_sent`        | TEXT    | NOT NULL                           | 送信されたメッセージ                     |
| `target_date`         | TEXT    | NOT NULL, YYYY-MM-DD形式           | 通知対象日                               |
| `scheduled_at`        | TEXT    | NOT NULL                           | 通知予定日時 (ISO 8601 UTC)              |
| `actually_sent_at`    | TEXT    | NULL許容                           | 実際の送信日時 (ISO 8601 UTC)            |
| `was_successful`      | INTEGER | NOT NULL DEFAULT 0                 | 送信成功フラグ                           |
| `error_message`       | TEXT    | NULL許容                           | エラー内容                               |
| `user_action`         | TEXT    | NULL許容                           | ユーザー反応 (opened/ignored)            |

## **RM-1.5. バックエンド処理 (Rust - Tauri Commands)** {#RM-1.5}

### **RM-1.5.1. 設定管理コマンド** {#RM-1.5.1}

1.  **`get_reminder_settings` コマンド**:
    *   **出力**: 全リマインダー設定の取得
    *   **用途**: 設定画面の初期表示

2.  **`update_reminder_setting` コマンド**:
    *   **入力**:
        ```typescript
        interface ReminderSettingUpdate {
          settingKey: string;
          isEnabled: boolean;
          scheduleTime?: string; // HH:MM
          scheduleDays?: number[]; // [0-6]
        }
        ```
    *   **処理**: 設定の更新とスケジューラーの再設定

### **RM-1.5.2. スケジューラー管理** {#RM-1.5.2}

1.  **`setup_notification_scheduler` コマンド**:
    *   **処理**: アプリ起動時のスケジューラー初期化
    *   **内容**: 有効な設定に基づくタイマー設定

2.  **`trigger_notification` コマンド** (内部関数):
    *   **処理**: 実際の通知送信処理
    *   **連携**: OS通知API呼び出し

### **RM-1.5.3. 条件判定** {#RM-1.5.3}

1.  **`should_send_checkin_reminder`**:
    *   **判定条件**: 
        * 設定が有効
        * 今日のチェックイン未実施
        * 設定時刻に到達
        * 今日初回の通知

2.  **`should_send_task_reminder`**:
    *   **判定条件**:
        * 設定が有効
        * 未完了タスクが存在
        * 設定時刻に到達
        * 当日未送信

## **RM-1.6. フロントエンド処理 (SvelteKit)** {#RM-1.6}

### **RM-1.6.1. 設定画面実装** {#RM-1.6.1}

*   **状態管理**: リマインダー設定専用のSvelteストア
*   **権限確認**: アプリ起動時・設定変更時の通知権限チェック
*   **UI更新**: 設定変更時のリアルタイム反映

### **RM-1.6.2. ディープリンク処理** {#RM-1.6.2}

*   **URLルーティング**: Svelteルーターでのスキーム対応
*   **画面遷移**: 通知からの直接画面遷移
*   **状態復元**: バックグラウンドからの復帰時の状態管理

### **RM-1.6.3. 通知許可フロー** {#RM-1.6.3}

1.  **初回設定**: オンボーディング時の権限要求
2.  **権限拒否時**: 機能制限の説明と再要求方法の案内
3.  **権限変更**: 設定画面での権限状態監視・更新

## **RM-1.7. スケジューリング実装** {#RM-1.7}

### **RM-1.7.1. タイマー管理** {#RM-1.7.1}

*   **実装方式**: Rustでのバックグラウンドタスク
*   **精度**: 分単位でのチェック（毎分00秒に実行）
*   **永続化**: アプリ再起動時の設定復元

### **RM-1.7.2. 時間計算** {#RM-1.7.2}

*   **タイムゾーン**: ユーザーのローカル時間での計算
*   **夏時間**: 自動調整対応
*   **日付変更**: 0時跨ぎでの適切な処理

### **RM-1.7.3. 信頼性** {#RM-1.7.3}

*   **重複防止**: 同一通知の重複送信防止
*   **失敗時対応**: 通知失敗時のリトライ機構
*   **ログ記録**: 送信履歴の記録と分析

## **RM-1.8. 不明点・検討事項リスト** {#RM-1.8}

### **RM-1.8.1. UI/UX 関連** {#RM-1.8.1}
*   **時刻入力UI**: 時分選択の具体的インターフェース（スピナー/スライダー/テキスト）
*   **プレビュー機能**: 設定変更時の通知テスト送信
*   **通知履歴**: 過去の通知送信履歴の表示要否
*   **スヌーズ機能**: 通知延期（5分後、30分後等）の実装
*   **通知音設定**: カスタム通知音の選択機能
*   **Do Not Disturb**: 就寝時間等での通知停止設定
*   **通知頻度**: 同じ内容の通知間隔制限

### **RM-1.8.2. スケジューリング・技術関連** {#RM-1.8.2}
*   **精度要件**: 通知時刻の許容誤差範囲
*   **バックグラウンド実行**: アプリ非アクティブ時の動作保証
*   **システム連携**: OS省電力モードでの動作
*   **マルチインスタンス**: 複数アプリ起動時の通知重複防止
*   **クロック変更**: システム時刻変更時の対応
*   **アプリ更新**: アップデート時のスケジューラー継続性

### **RM-1.8.3. プラットフォーム固有** {#RM-1.8.3}
*   **iOS制約**: バックグラウンド実行制限への対応
*   **Windows**: タスクトレイ常駐とスタートアップ登録
*   **macOS**: ログイン項目登録とサンドボックス制約
*   **権限管理**: プラットフォーム別の権限要求フロー
*   **通知スタイル**: OS別の通知表示カスタマイズ

### **RM-1.8.4. ユーザー体験関連** {#RM-1.8.4}
*   **初期設定**: デフォルト設定値の選定
*   **学習機能**: ユーザー行動に基づく最適時刻提案
*   **適応性**: 生活パターン変化への自動調整
*   **心理的配慮**: プレッシャーを与えない文言選択
*   **カスタマイズ**: ユーザーによるメッセージ編集機能

### **RM-1.8.5. データ・プライバシー関連** {#RM-1.8.5}
*   **通知内容**: 機密性のある情報の通知内容への含有
*   **ログ保存期間**: 通知履歴の保存期間と自動削除
*   **データ同期**: 複数デバイス間での設定同期（将来）
*   **匿名化**: 使用統計データの匿名化処理

### **RM-1.8.6. パフォーマンス・信頼性関連** {#RM-1.8.6}
*   **リソース使用量**: 常時監視によるCPU・メモリ使用量
*   **エラー処理**: 通知送信失敗時の代替手段
*   **ネットワーク**: オフライン時の通知動作
*   **バッテリー影響**: モバイル端末でのバッテリー消費
*   **テスト戦略**: 時間依存機能のテスト方法
*   **監視**: 通知成功率、ユーザー反応率の測定
