# **DC-1. デイリーチェックイン機能 仕様詳細** {#DC-1}

## **DC-1.1. 目的** {#DC-1.1}

ユーザーが毎日の心身の状態を記録する習慣を身につけ、自己理解を深め、無理のない行動計画の土台を作る。

## **DC-1.2. UI/UX** {#DC-1.2}

### **DC-1.2.1. 表示トリガーと形式** {#DC-1.2.1}

*   **トリガー**:
    *   アプリケーション起動時。
    *   ユーザーが設定した特定の時刻（リマインダー機能と連動）。
*   **表示形式**:
    *   モーダル形式で表示する。
    *   daisyUIのモーダルコンポーネント (`daisy-modal`) をベースとし、アプリケーションのテーマに合わせたスタイル調整を行う。

### **DC-1.2.2. 画面レイアウト** {#DC-1.2.2}

*   モーダル上部に「今日のチェックイン」というタイトルを表示する。
*   タイトル下に各入力項目を縦方向に配置する。
*   モーダル最下部に「記録する」ボタンと「キャンセル」（または閉じるアイコン）を配置する。

### **DC-1.2.3. 入力項目とUIコンポーネント** {#DC-1.2.3}

1.  **日付**:
    *   **表示**: 自動入力され、ユーザーによる編集は不可。YYYY年MM月DD日 (曜日) の形式で表示。
    *   **UI**: 通常のテキスト表示。
2.  **今の気分**:
    *   **入力**: 5段階の絵文字アイコンから1つを選択。
    *   **UI**: 横一列に並んだ絵文字アイコンボタン。選択されたアイコンは視覚的に強調（例: 背景色変更、拡大）。
    *   **絵文字候補**: 😭 (とても悪い), 😥 (悪い), 😐 (普通), 🙂 (良い), 😄 (とても良い)
        *   **検討事項**: 絵文字の具体的な選定、各OSでの表示差異の確認。SVGアイコンへの置き換えも検討。
3.  **気分の補足**:
    *   **入力**: 任意入力のテキストエリア。
    *   **UI**: `daisyui-textarea` を使用。高さは3行程度をデフォルトとし、入力に応じて可変とするか検討。
    *   **プレースホルダー**: 「例: 昨日よく眠れたので気分が良い」
    *   **バリデーション**: 最大500文字。
4.  **体の状態 (タグ形式)**:
    *   **入力**:
        *   事前定義されたタグリストから複数選択可能。
        *   ユーザーによる自由記述でのタグ追加も可能。
    *   **UI**:
        *   事前定義タグ: `daisyui-checkbox` または `daisyui-badge` をトグルボタンとして利用。
        *   自由記述タグ: テキスト入力フィールド (`daisyui-input`) と「追加」ボタン。追加されたタグは選択済みタグと同様に表示。
        *   選択済みタグは一覧で表示（例: `daisyui-badge` を使用）。
    *   **事前定義タグ候補**: 「寝不足」「元気」「頭痛」「肩こり」「リラックス」「ストレス」「疲労感」
        *   **検討事項**: タグの初期セット、ユーザーによるタグ管理機能（編集・削除）の要否。
    *   **バリデーション**: 各タグ最大20文字、全体で最大10個まで。
5.  **今日の「やらなきゃ」と感じること**:
    *   **入力**: 最大3つまで入力可能なテキストフィールド。
    *   **UI**: 各項目ごとに入力フィールド (`daisyui-input`) を用意。初期は1つ表示し、「＋追加」ボタンで最大3つまで動的にフィールドを増減させるか、常に3つ分のフィールドを表示するか検討。
    *   **プレースホルダー**: 「例: 朝の散歩をする」
    *   **バリデーション**: 各項目最大100文字。
6.  **それに対する今の気持ち**:
    *   **入力**: 選択式。
    *   **UI**: `daisyui-select` またはラジオボタン (`daisyui-radio`) 形式。
    *   **選択肢候補**: 「憂鬱だ」「気が重い」「まあまあ」「少し楽しみ」「やれそう！」
        *   **検討事項**: 選択肢の文言、数。

### **DC-1.2.4. フィードバック** {#DC-1.2.4}

*   「記録する」ボタン押下後、入力内容が正常に保存された場合:
    *   「今日も一日、あなたらしく。」といったポジティブなフィードバックメッセージを `daisyui-toast` で画面下部中央などに2〜3秒間表示する。
    *   **検討事項**: メッセージのバリエーション、表示アニメーション。
*   入力エラー時:
    *   各エラー箇所に具体的なエラーメッセージを表示する。

## **DC-1.3. データ構造 (SQLite: daily_checkins テーブル)** {#DC-1.3}

| カラム名             | 型      | 制約                               | 説明                                     |
| -------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `local_id`           | INTEGER | PRIMARY KEY AUTOINCREMENT          | ローカルID                               |
| `uuid`               | TEXT    | NOT NULL, UNIQUE                   | グローバル一意ID (UUID v4)               |
| `date`               | TEXT    | NOT NULL, UNIQUE, `YYYY-MM-DD`形式 | 記録日                                   |
| `mood_level`         | INTEGER | NOT NULL                           | 気分レベル (1:とても良い 〜 5:とても悪い)  |
| `mood_text`          | TEXT    | NULL許容, max 500 chars            | 気分の補足                               |
| `physical_state_tags`| TEXT    | NULL許容                           | 体の状態（タグをJSON配列文字列で保存）   |
| `physical_state_text`| TEXT    | NULL許容, max 500 chars            | 体の状態（自由記述、現在はUI上未定）     |
| `potential_todos`    | TEXT    | NULL許容                           | 「やらなきゃ」をJSON配列文字列で保存     |
| `feeling_for_todos`  | TEXT    | NULL許容                           | 「やらなきゃ」に対する気持ち             |
| `created_at`         | TEXT    | NOT NULL                           | 作成日時 (ISO 8601 UTC)                  |
| `updated_at`         | TEXT    | NOT NULL                           | 更新日時 (ISO 8601 UTC)                  |
| `deleted_at`         | TEXT    | NULL許容                           | 論理削除日時 (ISO 8601 UTC)              |

**検討事項・変更点:**
*   `mood_level`: 仕様書では5段階の絵文字アイコンで 😄 が最も良い評価でしたが、数値としては 1 が最も良いとするか、5 が最も良いとするか統一が必要です。ここでは仮に 1=とても良い, 2=良い, 3=普通, 4=悪い, 5=とても悪い とします。
*   `physical_state_text`: UI仕様には自由記述のテキストエリアが明記されていませんでしたが、データ構造には存在します。UIに含めるか、データ構造から削除するか検討が必要です。現時点ではUIに含めない前提で進めます。
*   `feeling_for_todos`: 「それに対する今の気持ち」を保存するカラム。型はTEXTとし、選択肢の文字列をそのまま保存します。
*   日時カラム (`created_at`, `updated_at`, `deleted_at`): 保存形式をISO 8601 UTCに統一します。

## **DC-1.4. バリデーションルール** {#DC-1.4}

### **DC-1.4.1. フロントエンド (SvelteKit)** {#DC-1.4.1}

*   **今の気分**: 必須選択。
*   **気分の補足**: 最大500文字。
*   **体の状態 (タグ)**: 各タグ最大20文字、全体で最大10個まで。
*   **今日の「やらなきゃ」と感じること**: 各項目最大100文字。少なくとも1つは入力されていることを推奨するが、必須ではない。
*   **それに対する今の気持ち**: 必須選択（「やらなきゃ」が1つ以上入力されている場合）。

### **DC-1.4.2. バックエンド (Rust)** {#DC-1.4.2}

*   フロントエンドと同様のバリデーションルールを適用し、データの整合性を担保する。
*   `date`: `YYYY-MM-DD` 形式であること、未来の日付でないこと。
*   `mood_level`: 1〜5の整数であること。
*   その他、各TEXT型カラムの文字数制限。

## **DC-1.5. バックエンド処理 (Rust - Tauri Commands)** {#DC-1.5}

### **DC-1.5.1. `record_daily_checkin` コマンド** {#DC-1.5.1}

*   **入力 (ペイロード)**:
    ```typescript
    interface DailyCheckinPayload {
      date: string; // YYYY-MM-DD
      moodLevel: number; // 1-5
      moodText?: string;
      physicalStateTags?: string[];
      potentialTodos?: string[];
      feelingForTodos?: string;
    }
    ```
*   **処理フロー**:
    1.  ペイロードのバリデーションを実行。
    2.  `uuid` を新規生成 (v4)。
    3.  `created_at`, `updated_at` に現在日時 (UTC) を設定。
    4.  `physicalStateTags`, `potentialTodos` をJSON文字列にシリアライズ。
    5.  `daily_checkins` テーブルにデータを挿入または更新 (指定された `date` のデータが既に存在する場合は更新、なければ新規挿入 - Upsert処理)。
        *   **検討事項**: 仕様書では `date` は UNIQUE なので、基本的には新規挿入。もし同日の再記録を許可するなら更新ロジックが必要。ここでは「その日の記録は1つ」とし、既に存在する場合はエラーとするか、上書きするかを明確にする。→ **方針**: その日の記録は1つとし、既に存在する場合はエラー（または上書き確認をフロントで行う）。ここではバックエンドはUpsertで対応し、フロントで制御する。
    6.  成功時は、保存されたデータの `uuid` を返す。
    7.  エラー発生時は、`AppError` 型でエラー情報を返す。

## **DC-1.6. フロントエンド処理 (SvelteKit)** {#DC-1.6}

### **DC-1.6.1. モーダル表示制御** {#DC-1.6.1}

*   アプリ起動時: `+layout.ts` またはルートの `+page.svelte` で、その日のチェックインが未記録の場合にモーダルを開く処理を実装。
    *   未記録判定: バックエンドに問い合わせるか、ローカルストレージ等で簡易的に管理するか検討。→ **方針**: バックエンドに `get_daily_checkin_by_date(today)` のようなコマンドを用意し確認する。
*   設定時刻: リマインダー機能と連携。通知クリックでモーダル表示。

### **DC-1.6.2. データ入力と状態管理** {#DC-1.6.2}

*   Svelteストア (`writable`) を使用して、各入力項目の状態を管理する。
*   入力変更時にリアルタイムでバリデーションを実行し、エラーメッセージを表示。

### **DC-1.6.3. データ保存処理** {#DC-1.6.3}

*   「記録する」ボタンクリック時:
    1.  最終バリデーションを実行。
    2.  Svelteストアから入力データを取得し、`DailyCheckinPayload` を作成。
    3.  Tauri API (`invoke`) を使用して `record_daily_checkin` コマンドを呼び出す。
    4.  ローディング状態（スピナー表示など）を管理。
    5.  コマンド成功時:
        *   ポジティブフィードバックを表示。
        *   モーダルを閉じる。
        *   必要に応じて関連する状態（例: 今日のチェックイン済みフラグ）を更新。
    6.  コマンド失敗時:
        *   エラーメッセージをユーザーに表示（例: `daisyui-alert`）。

## **DC-1.7. 不明点・検討事項リスト** {#DC-1.7}

### **DC-1.7.1. UI/UX 関連** {#DC-1.7.1}
*   絵文字アイコンの具体的な選定と各OSでの表示差異、SVGアイコンへの置き換え検討。
*   「体の状態」タグの初期セット、ユーザーによるタグ管理機能（編集・削除）の要否。
*   「今日の「やらなきゃ」」の入力フィールドUI（動的増減か固定数か）。
*   「それに対する今の気持ち」の選択肢の文言と数。
*   ポジティブフィードバックメッセージのバリエーションと表示アニメーション。
*   `mood_level` の数値と気分のマッピング（1が良いか5が良いか）。
*   **モーダルの表示タイミング詳細**: アプリ起動時の遅延（起動直後か、一定秒数後か）。
*   **モーダルの閉じる動作**: ESCキーやモーダル外クリックでの閉じる可否、未保存データの扱い。
*   **気分テキストエリアの高さ**: デフォルト3行で良いか、最大高さ制限の要否。
*   **タグUI詳細**: 事前定義タグと自由記述タグの視覚的区別、タグの削除方法（×ボタンか再クリックか）。
*   **「やらなきゃ」入力フィールドの削除**: 動的増減の場合、削除ボタンの位置と動作。
*   **レスポンシブ対応**: モバイル端末での表示最適化（入力フィールドサイズ、ボタン配置）。
*   **キーボードナビゲーション**: Tab遷移の順序、Enter/Spaceキーでの操作対応。
*   **アクセシビリティ**: スクリーンリーダー対応、色覚多様性への配慮、十分なコントラスト比。

### **DC-1.7.2. データ・ロジック関連** {#DC-1.7.2}
*   `physical_state_text` カラムのUIへの反映要否。
*   同日再記録の扱い（エラー、上書き確認など）。
*   アプリ起動時の未記録判定方法（バックエンド問い合わせかローカル管理か）。
*   **タイムゾーン処理**: ユーザーのローカル日時とUTC保存の整合性、日付境界での記録扱い。
*   **データの不整合対応**: JSONシリアライズ/デシリアライズエラー時の処理。
*   **オフライン対応**: ネットワーク未接続時のデータ保存方法（ローカルキューイング等）。
*   **データマイグレーション**: 将来的な機能追加に伴うテーブル構造変更への対応。
*   **バックアップ・復元**: ユーザーデータの保護とエクスポート機能の必要性。

### **DC-1.7.3. バリデーション・エラー処理関連** {#DC-1.7.3}
*   **リアルタイムバリデーション**: 入力中の即座チェックか、フォーカス離脱時か。
*   **エラーメッセージの国際化**: 日本語以外の言語対応予定の有無。
*   **ネットワークエラー処理**: タイムアウト、接続エラー時のリトライ機能。
*   **部分保存**: 一部項目のみ入力での保存可否（下書き機能）。

### **DC-1.7.4. パフォーマンス・技術関連** {#DC-1.7.4}
*   **データ読み込み最適化**: 起動時チェック処理の非同期化、ローディング表示。
*   **メモリ使用量**: 大量のタグデータやテキストの効率的管理。
*   **データベースインデックス**: 検索性能向上のためのインデックス設計。
*   **ログ・監査**: ユーザー操作の記録要否、デバッグ情報の収集レベル。

### **DC-1.7.5. セキュリティ・プライバシー関連** {#DC-1.7.5}
*   **データ暗号化**: ローカルSQLiteファイルの暗号化要否。
*   **入力値サニタイズ**: XSS対策、SQLインジェクション対策。
*   **プライバシー設定**: データ収集範囲の明示、ユーザー同意の取得方法。

### **DC-1.7.6. 運用・保守関連** {#DC-1.7.6}
*   **ログ出力**: エラー、操作履歴のログレベルと保存期間。
*   **アップデート時の互換性**: 既存データの移行方法、下位互換性の維持。
*   **テスト戦略**: 単体テスト、統合テスト、E2Eテストの範囲と自動化。
*   **監視・メトリクス**: アプリの利用状況、エラー率の測定方法。

---
