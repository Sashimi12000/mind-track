# **RF-1. ふりかえり機能 仕様詳細** {#RF-1}

## **RF-1.1. 目的** {#RF-1.1}

自身の行動パターン、気分の波、進捗を客観的に把握し、今後の行動改善や自己理解に繋げる。

## **RF-1.2. UI/UX** {#RF-1.2}

### **RF-1.2.1. ナビゲーション・レイアウト** {#RF-1.2.1}

*   **メニュー構成**: 
    *   「カレンダー」タブ
    *   「リスト」タブ
    *   「統計」タブ
*   **ページ構造**: タブ切り替え式のSPA構成
*   **共通要素**: 期間選択、日付ナビゲーション

### **RF-1.2.2. カレンダービュー** {#RF-1.2.2}

1.  **カレンダー表示**:
    *   **レイアウト**: 月表示カレンダー（7×6グリッド）
    *   **UI**: daisyUIのcalendarコンポーネントまたはカスタム実装
    *   **ナビゲーション**: 月送り/戻しボタン、年月選択ドロップダウン

2.  **日付セル表示**:
    *   **気分アイコン**: その日の気分レベルに対応する絵文字（小サイズ）
    *   **タスク達成率**: 「3/5」形式での完了/総数表示
    *   **記録状態**: 記録あり/なしでのセル背景色変更
    *   **当日マーク**: 今日の日付を特別表示

3.  **インタラクション**:
    *   **クリック**: 日付クリックで詳細記録モーダル表示
    *   **ホバー**: デスクトップでの簡易情報ツールチップ
    *   **選択**: 複数日選択での期間分析（将来拡張）

### **RF-1.2.3. リストビュー** {#RF-1.2.3}

1.  **期間選択**:
    *   **プリセット**: 過去7日間、過去30日間、今月、先月
    *   **カスタム**: 開始日・終了日の手動選択
    *   **UI**: `daisyui-select` + DatePickerコンポーネント

2.  **記録カード表示**:
    *   **レイアウト**: 日付ごとのカード形式、新しい順に配置
    *   **カード内容**: 
        * 日付・曜日
        * 気分アイコン + 補足テキスト（省略表示）
        * 体の状態タグ（主要なもの3個まで表示）
        * タスク達成状況（完了数/総数、進捗バー）
        * 「詳細を見る」リンク

3.  **フィルタリング**:
    *   **気分レベル**: 特定の気分レベルのみ表示
    *   **タスク達成率**: 高達成率/低達成率での絞り込み
    *   **記録完全性**: 完全記録/部分記録での絞り込み

### **RF-1.2.4. 統計ビュー** {#RF-1.2.4}

1.  **気分分析**:
    *   **分布グラフ**: 気分レベル別の日数・割合（棒グラフ）
    *   **推移グラフ**: 時系列での気分変化（折れ線グラフ）
    *   **平均値**: 期間内の平均気分レベル

2.  **タスク分析**:
    *   **完了率グラフ**: 日別タスク完了率の推移
    *   **総計データ**: 総タスク数、完了数、平均完了率
    *   **パターン分析**: 曜日別・時間帯別の傾向

3.  **体調分析**:
    *   **タグ頻度**: よく使われる体の状態タグランキング
    *   **相関分析**: 体調と気分・タスク達成率の関係性

### **RF-1.2.5. 詳細記録モーダル** {#RF-1.2.5}

*   **表示内容**: 
    * 完全なデイリーチェックイン記録
    * その日のマイクロタスク一覧（完了状況含む）
    * 達成ログ・フィードバック履歴
*   **操作**: 編集リンク、前日/次日ナビゲーション

## **RF-1.3. データ構造** {#RF-1.3}

### **RF-1.3.1. メインテーブル（既存）** {#RF-1.3.1}
*   `daily_checkins`: デイリーチェックイン記録
*   `micro_tasks`: マイクロタスク記録
*   `achievement_logs`: 達成ログ記録

### **RF-1.3.2. 統計キャッシュテーブル（新規）** {#RF-1.3.2}

| カラム名              | 型      | 制約                               | 説明                                     |
| --------------------- | ------- | ---------------------------------- | ---------------------------------------- |
| `date`                | TEXT    | PRIMARY KEY, `YYYY-MM-DD`形式      | 対象日                                   |
| `total_tasks`         | INTEGER | NOT NULL DEFAULT 0                 | その日の総タスク数                       |
| `completed_tasks`     | INTEGER | NOT NULL DEFAULT 0                 | その日の完了タスク数                     |
| `completion_rate`     | REAL    | NOT NULL DEFAULT 0.0               | 完了率 (0.0-1.0)                         |
| `mood_level`          | INTEGER | NULL許容                           | その日の気分レベル                       |
| `has_checkin`         | INTEGER | NOT NULL DEFAULT 0                 | チェックイン記録の有無                   |
| `calculated_at`       | TEXT    | NOT NULL                           | 統計計算日時 (ISO 8601 UTC)              |

## **RF-1.4. バリデーションルール** {#RF-1.4}

### **RF-1.4.1. フロントエンド** {#RF-1.4.1}
*   **期間選択**: 開始日 ≤ 終了日、未来日選択の制限
*   **日付範囲**: 過度に大きな範囲（例: 1年超）の制限
*   **データ取得**: 大量データ取得時の分割読み込み

### **RF-1.4.2. バックエンド** {#RF-1.4.2}
*   **日付形式**: `YYYY-MM-DD` 形式の厳密チェック
*   **期間範囲**: APIリクエストでの期間制限
*   **データ整合性**: 統計データとメインデータの整合性確認

## **RF-1.5. バックエンド処理 (Rust - Tauri Commands)** {#RF-1.5}

### **RF-1.5.1. `get_reflection_data` コマンド** {#RF-1.5.1}

*   **入力ペイロード**:
    ```typescript
    interface ReflectionDataRequest {
      startDate: string; // YYYY-MM-DD
      endDate: string;   // YYYY-MM-DD
      includeStats?: boolean;
      includeTasks?: boolean;
    }
    ```

*   **出力**:
    ```typescript
    interface ReflectionDataResponse {
      dailyRecords: DailyRecord[];
      statistics?: ReflectionStatistics;
    }

    interface DailyRecord {
      date: string;
      checkin?: DailyCheckin;
      tasks: MicroTask[];
      achievements: Achievement[];
      taskStats: {
        total: number;
        completed: number;
        completionRate: number;
      };
    }
    ```

### **RF-1.5.2. `get_calendar_overview` コマンド** {#RF-1.5.2}

*   **入力**: `{ year: number, month: number }`
*   **出力**: 月内各日の概要データ
*   **最適化**: 軽量データでの高速表示

### **RF-1.5.3. `calculate_statistics` コマンド** {#RF-1.5.3}

*   **入力**: 期間指定
*   **処理**: 
    1. 基本統計の計算
    2. 統計キャッシュテーブルの更新
    3. 高度な分析データの生成
*   **出力**: 総合統計データ

### **RF-1.5.4. `get_daily_detail` コマンド** {#RF-1.5.4}

*   **入力**: `{ date: string }`
*   **出力**: 指定日の完全な記録データ
*   **用途**: 詳細モーダル表示

## **RF-1.6. フロントエンド処理 (SvelteKit)** {#RF-1.6}

### **RF-1.6.1. 状態管理** {#RF-1.6.1}

*   **Svelteストア**:
    * `selectedDateStore`: 選択中の日付
    * `reflectionDataStore`: 表示中のデータ
    * `viewModeStore`: 表示モード（calendar/list/stats）
    * `filterStore`: フィルター設定
    * `loadingStore`: ローディング状態

### **RF-1.6.2. データフェッチング** {#RF-1.6.2}

*   **初期読み込み**: ページ表示時の今月データ取得
*   **遅延読み込み**: スクロール時の追加データ取得
*   **キャッシュ**: 取得済みデータのメモリキャッシュ
*   **更新**: 他画面での記録更新時の自動反映

### **RF-1.6.3. パフォーマンス最適化** {#RF-1.6.3}

*   **仮想スクロール**: 大量リストでの表示最適化
*   **データ分割**: 月単位・週単位での分割取得
*   **画像最適化**: グラフ・チャートの効率的描画

## **RF-1.7. グラフ・チャート実装** {#RF-1.7}

### **RF-1.7.1. ライブラリ選定** {#RF-1.7.1}
*   **候補**: Chart.js、D3.js、ApexCharts
*   **要件**: 軽量性、レスポンシブ対応、カスタマイズ性

### **RF-1.7.2. グラフ種類** {#RF-1.7.2}
*   **棒グラフ**: 気分分布、タグ頻度
*   **折れ線グラフ**: 気分・完了率の推移
*   **円グラフ**: 体調タグの構成比
*   **散布図**: 相関分析（将来拡張）

## **RF-1.8. 不明点・検討事項リスト** {#RF-1.8}

### **RF-1.8.1. UI/UX 関連** {#RF-1.8.1}
*   **カレンダー実装**: サードパーティライブラリ vs 自前実装
*   **モバイル対応**: タッチ操作でのカレンダーナビゲーション
*   **データ可視化**: グラフの種類・色彩設計
*   **空状態表示**: データが無い期間の表示内容
*   **ローディング表示**: 大量データ読み込み時のUX
*   **レスポンシブ**: 小画面でのカレンダー・統計表示
*   **タブ遷移**: ブラウザ履歴との連携
*   **キーボード操作**: カレンダーナビゲーションのキーボード対応

### **RF-1.8.2. データ・パフォーマンス関連** {#RF-1.8.2}
*   **データ取得範囲**: 一度に取得する最大期間
*   **統計計算**: リアルタイム計算 vs 事前計算キャッシュ
*   **メモリ使用量**: 大量データ保持時のメモリ効率
*   **データベース最適化**: 分析クエリのインデックス設計
*   **バックグラウンド処理**: 統計計算の非同期実行
*   **データ圧縮**: 長期間データの効率的保存

### **RF-1.8.3. 分析・統計関連** {#RF-1.8.3}
*   **統計手法**: 平均、中央値、標準偏差等の計算対象
*   **相関分析**: 気分と行動パターンの関係性分析
*   **トレンド分析**: 長期的な変化傾向の検出
*   **異常値検出**: 通常パターンからの逸脱検知
*   **予測機能**: 過去データからの将来予測（将来拡張）
*   **比較分析**: 期間比較、同曜日比較等

### **RF-1.8.4. プライバシー・セキュリティ関連** {#RF-1.8.4}
*   **データ匿名化**: 統計データの個人情報保護
*   **エクスポート機能**: 分析結果のデータ出力
*   **データ保存期間**: 古いデータの自動削除ポリシー
*   **アクセス制御**: 機密性の高い分析データの保護

### **RF-1.8.5. ユーザビリティ関連** {#RF-1.8.5}
*   **インサイト表示**: 分析結果から得られる気づきの提示
*   **アクション提案**: 改善提案の自動生成
*   **進捗可視化**: 目標に対する進捗の表示
*   **比較基準**: 自分の過去との比較、一般的な基準との比較
*   **カスタマイズ**: ユーザーによる分析指標の選択

### **RF-1.8.6. 技術・実装関連** {#RF-1.8.6}
*   **リアルタイム更新**: 他機能での記録更新時の反映
*   **オフライン対応**: ネットワーク断絶時の表示
*   **データ移行**: 統計テーブル追加時の既存データ処理
*   **パフォーマンス監視**: 大量データ処理時の性能測定
*   **エラー処理**: 統計計算失敗時のフォールバック
*   **テスト戦略**: 複雑な分析ロジックのテスト方法
